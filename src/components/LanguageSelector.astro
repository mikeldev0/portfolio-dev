---
import LanguageArrowIcon from "../icons/LanguageArrowIcon.astro";
---
<div class="ml-2 relative hover:scale-105 transition duration-200 ease-in-out">
    <select
        id="language-selector"
        class="appearance-none bg-transparent text-gray-800 dark:text-gray-200 text-xs md:text-sm px-2 py-2 pr-6 rounded-md hover:text-purple-500 dark:hover:text-purple-400 focus:outline-none cursor-pointer "
    >
        <!-- Las opciones se rellenarán dinámicamente en el cliente -->
    </select>
    <LanguageArrowIcon />
</div>

<script is:inline>
    const LANGUAGES = [
        { code: "en" },
        { code: "es" },
        { code: "fr" },
        { code: "de" },
        { code: "it" },
    ];
    const languageSelector = document.getElementById("language-selector");

    function getLanguagePreference() {
        if (typeof localStorage !== "undefined") {
            return localStorage.getItem("language") ?? "en";
        }
        return "en";
    }
    function setLanguagePreference(code) {
        localStorage.setItem("language", code);
    }
    async function loadLanguageNames(lang) {
        try {
            const res = await fetch(`/locales/${lang}.json`);
            const data = await res.json();
            return data.languageNames;
        } catch (e) {
            return {
                en: "English",
                es: "Español",
                fr: "Français",
                de: "Deutsch",
                it: "Italiano"
            };
        }
    }
    async function populateOptions() {
        const code = getLanguagePreference();
        const languageNames = await loadLanguageNames(code);
        languageSelector.innerHTML = LANGUAGES.map(lang => `<option value="${lang.code}">${languageNames[lang.code] || lang.code}</option>`).join("");
        languageSelector.value = code;
    }
    populateOptions();

    languageSelector.addEventListener("change", (e) => {
        const code = e.target.value;
        setLanguagePreference(code);
        window.location.reload(); // recargar para aplicar el idioma
    });
</script>
